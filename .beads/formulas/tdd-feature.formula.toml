description = "TDD Feature Development - Acceptance criteria first, design second, test-driven implementation third. Human review gates at criteria and design phases."
formula = "tdd-feature"
type = "workflow"
version = 1

[[steps]]
id = "criteria"
title = "Write acceptance criteria for {{feature}}"
description = """FIRST: Create feature folder in docs/features/

Determine the next available feature number (e.g., 001, 002, 003) by checking existing folders in docs/features/.
Create a new folder: docs/features/[NNN]-{{feature}}/

THEN: Write acceptance criteria using Gherkin syntax (Given/When/Then).

Cover:
- Happy path scenarios
- Edge cases
- Error conditions
- User-facing behavior (not implementation details)

Output location: docs/features/[NNN]-{{feature}}/acceptance-criteria.md

The acceptance criteria file should be in markdown format with Gherkin scenarios in code blocks."""

[[steps]]
id = "criteria-review"
title = "Review acceptance criteria"
needs = ["criteria"]
description = """HUMAN REVIEW GATE: Present criteria to human for review.

Checklist:
- Are scenarios complete?
- Is the language clear and unambiguous?
- Are edge cases covered?
- Any missing scenarios?

Wait for human approval before proceeding.

AFTER APPROVAL: Commit acceptance criteria artifacts
-----------------------------------------------------
Once human approves, commit the acceptance criteria documents:

  git add docs/features/
  git add .beads/work-docs/
  git commit -m "Acceptance criteria approved for {{feature}}

  - Feature file with all scenarios
  - Summary and review checklist

  Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

This preserves the approved criteria in version control."""

[[steps]]
id = "design"
title = "Write high-level design for {{feature}}"
needs = ["criteria-review"]
description = """Create high-level design based on approved acceptance criteria.

FIRST: Scan existing design decisions and architecture patterns
-------------------------------------------------------------------
Before creating the design, review existing architectural guidance:

1. Scan docs/adr/ for Architecture Decision Records (ADRs)
   - Look for patterns, constraints, and conventions
   - Identify relevant decisions that apply to this feature
   - Note any architectural principles to follow

2. Scan docs/architecture/ for architecture documentation
   - Review system architecture diagrams and patterns
   - Understand existing component boundaries
   - Identify integration points and dependencies

3. Apply discovered patterns and decisions to the design

Output location: docs/features/[NNN]-{{feature}}/high-level-design.md

Include:
- Architecture overview (how it fits into existing system)
- Key components/modules involved
- Data flow
- API changes (if any)
- Dependencies
- Risks and mitigations
- Implementation plan using RED-GREEN-REFACTOR TDD cycles
- References to relevant ADRs and architecture docs

Keep it high-level - implementation details come during TDD.

CRITICAL: Design must include TDD implementation plan:
- Identify which acceptance criteria map to which tests
- Plan RED-GREEN-REFACTOR cycle for each criterion
- Tests written FIRST, then code to pass them
- Each criterion = one complete TDD cycle"""

[[steps]]
id = "design-review"
title = "Review high-level design"
needs = ["design"]
description = """HUMAN REVIEW GATE: Present design to human for review and refinement.

Discuss:
- Does the approach make sense?
- Any architectural concerns?
- Simpler alternatives?
- Anything missing?

Iterate until human approves the design.

AFTER APPROVAL: Commit design artifacts
----------------------------------------
Once human approves, commit the design documents:

  git add docs/features/
  git add .beads/work-docs/
  git commit -m "High-level design approved for {{feature}}

  - Architecture and component design
  - TDD implementation plan
  - Risk analysis and mitigations

  Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

This preserves the approved design in version control before implementation begins."""

[[steps]]
id = "tdd-loop"
title = "TDD implementation of {{feature}}"
needs = ["design-review"]
description = """Execute RED-GREEN-REFACTOR TDD loop for each acceptance criterion using Claude tasks and team coordination.

SETUP - Create Team and Tasks:
-------------------------------
1. Create a team for this feature implementation:
   TeamCreate(
     team_name="{{feature}}-tdd",
     description="TDD implementation of {{feature}} with RED-GREEN-REFACTOR cycles"
   )

2. Read acceptance criteria file to extract all scenarios:
   - Location: docs/features/[NNN]-{{feature}}/acceptance-criteria.md
   - Extract each acceptance criterion (AC1, AC2, AC3...)

3. Create Claude tasks for EACH acceptance criterion. Set up the dependencies so implementation of each AC
   happens in SEQUENTIAL order. For example:

   For AC1 (first criterion):
   TaskCreate(
     subject="RED-GREEN-REFACTOR: AC1 - [description]",
     description='''Execute complete TDD cycle for acceptance criterion 1.

     CONTEXT:
     - Feature: {{feature}}
     - Acceptance Criterion: AC1 from acceptance-criteria.md
     - This is the FIRST AC - no dependencies

     RED PHASE:
     1. Read acceptance criteria for AC1
     2. Write acceptance test FIRST (in acceptance/ directory)
     3. Use mocks for external dependencies (e.g., MockOcrEngine)
     4. Run test → Verify it FAILS (red)
     5. Commit: "RED: AC1 - [description]"

     GREEN PHASE:
     1. Write minimal code to make test pass
     2. Run test → Verify it PASSES (green)
     3. Commit: "GREEN: AC1 - [description]"

     REFACTOR PHASE:
     1. Use /ocr-review command to review this branch against main
     2. Refactor to fix issues
     3. Run test → Verify STILL PASSES
     4. Commit: "REFACTOR: AC1 - [description]"

     COMPLETION:
     - Mark task as completed when all three phases done
     - All tests passing
     ''',
     activeForm="Implementing AC1 with RED-GREEN-REFACTOR"
   )

   For AC2 (second criterion):
   TaskCreate(
     subject="RED-GREEN-REFACTOR: AC2 - [description]",
     description='''Execute complete TDD cycle for acceptance criterion 2.

     CONTEXT:
     - Feature: {{feature}}
     - Acceptance Criterion: AC2 from acceptance-criteria.md
     - DEPENDS ON: AC1 must be complete (builds on AC1's code)

     [Same RED-GREEN-REFACTOR workflow as AC1]
     ''',
     activeForm="Implementing AC2 with RED-GREEN-REFACTOR"
   )

   Then use TaskUpdate to set dependency:
   TaskUpdate(taskId="AC2-task-id", addBlockedBy=["AC1-task-id"])

   REPEAT for AC3, AC4, etc. - each blocked by the previous AC

4. Spawn teammates to work on tasks:

   Spawn 1-2 engineer teammates using Task tool:
   Task(
     subagent_type="general-purpose",
     team_name="{{feature}}-tdd",
     name="tdd-engineer-1",
     prompt='''You are a TDD engineer on the {{feature}}-tdd team.

     WORKFLOW:
     1. Check TaskList to find available tasks (not blocked)
     2. Claim the next available task (lowest ID first)
     3. Execute the RED-GREEN-REFACTOR cycle as described
     4. Mark task completed when done
     5. Check TaskList for next task
     6. Repeat until all tasks complete

     CRITICAL RULES:
     - NEVER write production code without failing test first
     - Each phase = separate git commit
     - Tests must pass before marking task complete
     - Follow clean code principles
     - Sequential execution - tasks have dependencies
     '''
   )

MONITORING:
-----------
While teammates work:
1. Monitor task progress using TaskList
2. Teammates will automatically work through tasks sequentially
3. Each AC builds on previous AC's code
4. No approval needed between ACs

COMPLETION:
-----------
When all AC tasks are completed:

1. Verify all tests pass:
   - Run full test suite
   - Confirm no regressions

2. Make sure all changes are committed and the worktree branch is in sync with main. Resolve any merge conflicts

3. Shutdown teammates:
   SendMessage(
     type="shutdown_request",
     recipient="tdd-engineer-1",
     content="All ACs complete, shutting down"
   )

5. Delete team:
   TeamDelete()

5. Mark this step complete

KEY REQUIREMENTS:
-----------------
- Use Claude tasks (TaskCreate/TaskUpdate/TaskList) NOT subagents for ACs
- Use TeamCreate and teammates for implementation
- Sequential execution via task dependencies (blockedBy)
- Each AC = one complete RED-GREEN-REFACTOR cycle
- Each AC builds on previous AC's code
- No approval between ACs - fully automated"""

[[steps]]
id = "code-review"
title = "Code review for {{feature}}"
needs = ["tdd-loop"]
description = """Run comprehensive code review using the code-review formula.

EXECUTION:
Use the /ocr-review command:

  /ocr-review for branch {{feature branch}} against main

REVIEW FINDINGS:
----------------
After the code-review formula completes:

1. Read the synthesis report: .reviews/[review-id]/review-summary.md

2. Address Critical Issues (P0):
   - MUST fix before merge
   - Create beads for each critical issue
   - Fix and verify

3. Address Major Issues (P1):
   - SHOULD fix before merge
   - Create beads as needed
   - Fix or document why deferred

4. Document Minor Issues (P2):
   - Nice to have
   - Add to technical debt tracking if not addressed

5. Commit review artifacts:
   git commit -m "Fixed P0 and P1 issues after comprehensive code review"

   - Comprehensive review via code-review formula
   - Addressed all critical and major issues

   Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

BLOCKING:
---------
Do NOT proceed to submit step if there are unresolved P0 (Critical) issues.
All critical issues must be fixed before the feature can be submitted for merge."""

[[steps]]
id = "submit"
title = "Submit {{feature}} for merge"
needs = ["code-review"]
description = """Final submission after all TDD iterations and code review complete.

Checklist:
- All acceptance tests pass
- Code review completed (all P0 issues resolved)
- No regressions in existing tests
- Git status clean
- Ready to push/merge"""

[vars]
[vars.feature]
description = "The feature being implemented"
required = true

[vars.assignee]
description = "Who is assigned to this work"
