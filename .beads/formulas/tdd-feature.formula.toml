description = "TDD Feature Development - Acceptance criteria first, design second, test-driven implementation third. Human review gates at criteria and design phases."
formula = "tdd-feature"
type = "workflow"
version = 1

[[steps]]
id = "criteria"
title = "Write acceptance criteria for {{feature}}"
description = """FIRST: Create feature folder in docs/features/

Determine the next available feature number (e.g., 001, 002, 003) by checking existing folders in docs/features/.
Create a new folder: docs/features/[NNN]-{{feature}}/

THEN: Write acceptance criteria using Gherkin syntax (Given/When/Then).

Cover:
- Happy path scenarios
- Edge cases
- Error conditions
- User-facing behavior (not implementation details)

Output location: docs/features/[NNN]-{{feature}}/acceptance-criteria.md

The acceptance criteria file should be in markdown format with Gherkin scenarios in code blocks."""

[[steps]]
id = "criteria-review"
title = "Review acceptance criteria"
needs = ["criteria"]
description = """HUMAN REVIEW GATE: Present criteria to human for review.

Checklist:
- Are scenarios complete?
- Is the language clear and unambiguous?
- Are edge cases covered?
- Any missing scenarios?

Wait for human approval before proceeding.

AFTER APPROVAL: Commit acceptance criteria artifacts
-----------------------------------------------------
Once human approves, commit the acceptance criteria documents:

  git add docs/features/
  git add .beads/work-docs/
  git commit -m "Acceptance criteria approved for {{feature}}

  - Feature file with all scenarios
  - Summary and review checklist

  Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

This preserves the approved criteria in version control."""

[[steps]]
id = "design"
title = "Write high-level design for {{feature}}"
needs = ["criteria-review"]
description = """Create high-level design based on approved acceptance criteria.

FIRST: Scan existing design decisions and architecture patterns
-------------------------------------------------------------------
Before creating the design, review existing architectural guidance:

1. Scan docs/adr/ for Architecture Decision Records (ADRs)
   - Look for patterns, constraints, and conventions
   - Identify relevant decisions that apply to this feature
   - Note any architectural principles to follow

2. Scan docs/architecture/ for architecture documentation
   - Review system architecture diagrams and patterns
   - Understand existing component boundaries
   - Identify integration points and dependencies

3. Apply discovered patterns and decisions to the design

Output location: docs/features/[NNN]-{{feature}}/high-level-design.md

Include:
- Architecture overview (how it fits into existing system)
- Key components/modules involved
- Data flow
- API changes (if any)
- Dependencies
- Risks and mitigations
- Implementation plan using RED-GREEN-REFACTOR TDD cycles
- References to relevant ADRs and architecture docs

Keep it high-level - implementation details come during TDD.

CRITICAL: Design must include TDD implementation plan:
- Identify which acceptance criteria map to which tests
- Plan RED-GREEN-REFACTOR cycle for each criterion
- Tests written FIRST, then code to pass them
- Each criterion = one complete TDD cycle"""

[[steps]]
id = "design-review"
title = "Review high-level design"
needs = ["design"]
description = """HUMAN REVIEW GATE: Present design to human for review and refinement.

Discuss:
- Does the approach make sense?
- Any architectural concerns?
- Simpler alternatives?
- Anything missing?

Iterate until human approves the design.

AFTER APPROVAL: Commit design artifacts
----------------------------------------
Once human approves, commit the design documents:

  git add docs/features/
  git add .beads/work-docs/
  git commit -m "High-level design approved for {{feature}}

  - Architecture and component design
  - TDD implementation plan
  - Risk analysis and mitigations

  Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

This preserves the approved design in version control before implementation begins."""

[[steps]]
id = "tdd-loop"
title = "TDD implementation of {{feature}}"
needs = ["design-review"]
description = """Execute RED-GREEN-REFACTOR TDD loop for each acceptance criterion SEQUENTIALLY.

CRITICAL: Each AC runs in its own fresh context (separate subagent).
Each AC builds on the previous one's changes.
Do NOT ask for approval - execute all ACs automatically.

SETUP:
------
1. Mark THIS task (the parent TDD implementation task) as in_progress:
   bd update [this-molecule-id] --status in_progress

2. Read the feature file (e.g., docs/features/{{feature}}.feature) to extract
   all acceptance criteria scenarios (AC1, AC2, AC3...).

WORKFLOW - FOR EACH ACCEPTANCE CRITERION (SEQUENTIAL):
-------------------------------------------------------

For each AC in the feature file:

A. Create bead for this AC:
   bd create "TDD: AC[N] - [criterion description]" --parent [this-molecule-id]

B. Spawn RED-GREEN subagent using Task tool:

   Task(subagent_type="general-purpose", prompt='''
   Execute RED-GREEN phases for acceptance criterion bead [bead-id].

   CONTEXT:
   - Feature: {{feature}}
   - Acceptance Criterion: AC[N]
   - Feature file: docs/features/{{feature}}.feature
   - This is AC [N] of [total] - builds on previous ACs

   WORKFLOW:
   1. Start work:
      bd update [bead-id] --status in_progress

   2. Read feature file to understand THIS acceptance criterion

   3. RED Phase - Write failing test FIRST:
      - Write acceptance test for this criterion ONLY
      - Tests go in acceptance/ directory
      - Use mocks (e.g., MockOcrEngine) for fast tests
      - Run test → Verify it FAILS (red)
      - Commit: "RED: AC[N] - [description]"

   4. GREEN Phase - Make it pass:
      - Write minimal code to pass test
      - Run test → Verify it PASSES (green)
      - Commit: "GREEN: AC[N] - [description]"

   5. DO NOT close bead - leave it in_progress for REFACTOR phase

   CRITICAL RULES:
   - NEVER write production code without a failing test first
   - Tests written in acceptance/ directory
   - Each phase = separate git commit
   - Verify test results at each phase
   - DO NOT REFACTOR - that's a separate step
   ''')

C. Wait for RED-GREEN subagent to complete

D. Spawn REFACTOR subagent using Task tool:

   Task(subagent_type="general-purpose", prompt='''
   Execute REFACTOR phase for acceptance criterion bead [bead-id].

   CONTEXT:
   - Feature: {{feature}}
   - Acceptance Criterion: AC[N]
   - RED and GREEN phases are complete
   - Test is passing

   WORKFLOW:
   1. Verify test passes:
      - Run the acceptance test for AC[N]
      - Confirm it's GREEN

   2. REFACTOR Phase - Clean up and enforce coding guidelines:
      - Improve code quality without changing behavior
      - Follow clean code principles from .ai-pack/quality/clean-code/
      - Enforce project coding standards and conventions
      - Check for:
        * Proper naming conventions
        * Code duplication (DRY principle)
        * Function/method length and complexity
        * Separation of concerns
        * Type safety and proper typing
        * Error handling patterns
        * Code comments where needed (especially for complex logic)
      - Run test → Verify STILL PASSES (green)

   3. Stage changes for OCR review:
      - Stage all changes in the worktree:
        git add -A

   4. Run OCR code review:
      - Execute the OCR review using the Skill tool:
        Skill(skill="ocr:review")
      - Review the findings and recommendations
      - Apply the recommendations from the OCR review
      - Ensure test still passes after applying recommendations

   5. Commit refactored code:
      - Commit: "REFACTOR: AC[N] - [description]"

   6. Close bead:
      bd update [bead-id] --status closed

   CRITICAL RULES:
   - Only refactor, don't change behavior
   - Test must stay green
   - If refactor breaks test, fix it before closing
   - All coding guidelines must be followed
   - Reference .ai-pack/quality/ for standards
   - OCR review is mandatory - must run and apply recommendations
   ''')

E. Wait for REFACTOR subagent to complete

F. REPEAT for next AC (sequential execution)

AFTER ALL CRITERIA COMPLETE:
-----------------------------
When ALL acceptance criteria have closed beads:

1. Run full test suite to verify no regressions

2. Close parent task:
   bd update [this-molecule-id] --status closed

KEY REQUIREMENTS:
-----------------
- Execute ACs SEQUENTIALLY (AC1, then AC2, then AC3...)
- Each AC has TWO subagents: RED-GREEN, then REFACTOR
- Each subagent runs in fresh context
- No approval between ACs or between RED-GREEN and REFACTOR
- Each AC builds on code from previous ACs"""

[[steps]]
id = "code-review"
title = "Code review for {{feature}}"
needs = ["tdd-loop"]
description = """Run comprehensive code review using the code-review formula.

Execute the code-review formula to review the implemented feature:

EXECUTION:
----------
Use bt (beads formula tool) to invoke the code-review formula:

  bt code-review --branch {{feature-branch}} --preset gate

This will spawn parallel review agents (convoy pattern) covering:
- Wiring: Dependencies added but not used
- Security: Vulnerabilities and security issues
- Smells: Anti-patterns and technical debt
- Test Quality: Test meaningfulness verification

The review will generate findings in .reviews/ directory.

REVIEW FINDINGS:
----------------
After the code-review formula completes:

1. Read the synthesis report: .reviews/[review-id]/review-summary.md

2. Address Critical Issues (P0):
   - MUST fix before merge
   - Create beads for each critical issue
   - Fix and verify

3. Address Major Issues (P1):
   - SHOULD fix before merge
   - Create beads as needed
   - Fix or document why deferred

4. Document Minor Issues (P2):
   - Nice to have
   - Add to technical debt tracking if not addressed

5. Commit review artifacts:
   git add .reviews/
   git commit -m "Code review completed for {{feature}}

   - Comprehensive review via code-review formula
   - Addressed all critical and major issues

   Co-Authored-By: Claude (hubgpt-chat-completions-claude-sonnet-4-5) <noreply@anthropic.com>"

BLOCKING:
---------
Do NOT proceed to submit step if there are unresolved P0 (Critical) issues.
All critical issues must be fixed before the feature can be submitted for merge."""

[[steps]]
id = "submit"
title = "Submit {{feature}} for merge"
needs = ["code-review"]
description = """Final submission after all TDD iterations and code review complete.

Checklist:
- All acceptance tests pass
- Code review completed (all P0 issues resolved)
- No regressions in existing tests
- Git status clean
- Ready to push/merge"""

[vars]
[vars.feature]
description = "The feature being implemented"
required = true

[vars.assignee]
description = "Who is assigned to this work"
